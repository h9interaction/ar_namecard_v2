<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•„ë°”íƒ€ ì»¤ìŠ¤í„°ë§ˆì´ì§• - AR ëª…í•¨</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            display: block;
            padding: 30px;
            padding-right: 430px;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .right-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            position: fixed;
            top: 20px;
            right: 20px;
            width: 380px;
            height: fit-content;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            z-index: 1000;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
        }

        .section-title {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        /* ì¸ì¦ ì„¹ì…˜ */
        .auth-section {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            color: #2d3436;
        }

        .auth-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .auth-controls input {
            flex: 1;
            min-width: 300px;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .auth-controls input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .status {
            padding: 12px 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
            font-weight: 500;
        }

        .status.loading {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e17055 0%, #d63031 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #636e72 0%, #2d3436 100%);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #667eea;
            color: #667eea;
        }

        .btn-outline:hover {
            background: #667eea;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ì•„ë°”íƒ€ ì„ íƒ ì˜ì—­ */
        .avatar-categories {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .avatar-category {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .avatar-category.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .category-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #495057;
        }

        .category-selection {
            font-size: 0.9em;
            color: #667eea;
            font-weight: 500;
        }

        .avatar-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 15px;
        }

        .avatar-option {
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 12px;
            overflow: hidden;
        }

        .avatar-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .avatar-option.selected {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .avatar-option.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 5px;
            right: 5px;
            background: #667eea;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .avatar-option img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 12px;
        }

        .avatar-option-name {
            text-align: center;
            font-size: 0.8em;
            margin-top: 5px;
            color: #495057;
            font-weight: 500;
        }

        /* ì•„ì´í…œ ì„ íƒ ì˜ì—­ */
        .item-categories {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .item-category {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
        }

        .item-category.role-category {
            border-color: #e17055;
            background: #fff8f6;
        }

        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
        }

        .item-card {
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .item-card img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }

        .item-card-name {
            padding: 8px;
            text-align: center;
            font-size: 0.8em;
            color: #495057;
            font-weight: 500;
        }

        /* ìŠ¬ë¡¯ ì‹œìŠ¤í…œ */
        .item-slots {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .item-slot {
            width: 100px;
            height: 100px;
            border: 3px dashed #dee2e6;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            background: #f8f9fa;
        }

        .item-slot.role-slot {
            border-color: #e17055;
            background: #fff8f6;
        }

        .item-slot.dragover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: scale(1.05);
        }

        .item-slot.filled {
            border-color: #00b894;
            border-style: solid;
            background: white;
        }

        .item-slot-label {
            font-size: 0.7em;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .item-slot-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .item-slot img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }

        .item-slot-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e17055;
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: none;
        }

        .item-slot.filled:hover .item-slot-remove {
            display: block;
        }

        /* ë©”ì‹œì§€ ì…ë ¥ */
        .message-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            resize: none;
            font-family: inherit;
        }

        .message-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .message-counter {
            text-align: right;
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 5px;
        }

        /* ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ */
        .preview-section {
            text-align: center;
        }

        .preview-canvas {
            border: 2px solid #e9ecef;
            border-radius: 15px;
            background: #f8f9fa;
            margin-bottom: 20px;
            max-width: 100%;
        }

        .preview-placeholder {
            width: 350px;
            height: 350px;
            border: 3px dashed #dee2e6;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.1em;
            margin: 0 auto 20px;
        }

        .selected-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .selected-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .selected-item img {
            width: 30px;
            height: 30px;
            object-fit: cover;
            border-radius: 4px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .right-panel {
                position: static;
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
                padding-right: 20px;
            }
            
            .right-panel {
                position: static;
                width: 100%;
                max-height: none;
                margin-top: 30px;
                right: auto;
                top: auto;
            }
            
            .auth-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .auth-controls input {
                min-width: auto;
            }
            
            .item-slots {
                flex-wrap: wrap;
            }
            
            .avatar-options {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            }
            
            .item-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ ì•„ë°”íƒ€ ì»¤ìŠ¤í„°ë§ˆì´ì§•</h1>
            <p>ë‚˜ë§Œì˜ ì•„ë°”íƒ€ì™€ ì•„ì´í…œì„ ì„ íƒí•˜ì—¬ ê°œì„± ë„˜ì¹˜ëŠ” ëª…í•¨ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <!-- ì¸ì¦ ì„¹ì…˜ -->
                <div class="section auth-section">
                    <div class="section-title">ğŸ” ì‚¬ìš©ì ì¸ì¦</div>
                    <p style="margin-bottom: 15px;">ì»¤ìŠ¤í„°ë§ˆì´ì§• ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                    <div class="auth-controls">
                        <input type="text" id="userToken" placeholder="ì‚¬ìš©ì JWT í† í° ì…ë ¥">
                        <button class="btn btn-primary" onclick="setUserToken()">í† í° ì„¤ì •</button>
                        <button class="btn btn-success" onclick="getUserToken()">í…ŒìŠ¤íŠ¸ í† í° ìƒì„±</button>
                        <button class="btn btn-secondary" onclick="clearUserToken()">í† í° ì´ˆê¸°í™”</button>
                    </div>
                    <div id="authStatus"></div>
                </div>

                <!-- ì•„ë°”íƒ€ ì„ íƒ ì„¹ì…˜ -->
                <div class="section">
                    <div class="section-title">ğŸ‘¤ ì•„ë°”íƒ€ ì„ íƒ</div>
                    <div id="avatarStatus"></div>
                    <div id="avatarCategories" class="avatar-categories"></div>
                </div>

                <!-- ì—­í•  ì•„ì´í…œ ì„ íƒ ì„¹ì…˜ -->
                <div class="section">
                    <div class="section-title">ğŸ’¼ ì—­í•  ì„ íƒ</div>
                    <div id="roleStatus"></div>
                    <div id="roleSlot" class="item-slots">
                        <div class="item-slot role-slot" data-slot="role">
                            <div class="item-slot-label">ì—­í• </div>
                            <div class="item-slot-content">
                                <span style="font-size: 0.8em; color: #6c757d;">ì—­í• ì„ ì„ íƒí•˜ì„¸ìš”</span>
                            </div>
                            <button class="item-slot-remove" onclick="removeFromSlot('role')">Ã—</button>
                        </div>
                    </div>
                    <div id="roleCategory" class="item-category role-category"></div>
                </div>

                <!-- ì¼ë°˜ ì•„ì´í…œ ì„ íƒ ì„¹ì…˜ -->
                <div class="section">
                    <div class="section-title">ğŸ® ì•„ì´í…œ ì„ íƒ</div>
                    <div id="itemStatus"></div>
                    <div class="item-slots">
                        <div class="item-slot" data-slot="item1">
                            <div class="item-slot-label">ì•„ì´í…œ 1</div>
                            <div class="item-slot-content">
                                <span style="font-size: 0.8em; color: #6c757d;">ì•„ì´í…œì„ ì„ íƒí•˜ì„¸ìš”</span>
                            </div>
                            <button class="item-slot-remove" onclick="removeFromSlot('item1')">Ã—</button>
                        </div>
                        <div class="item-slot" data-slot="item2">
                            <div class="item-slot-label">ì•„ì´í…œ 2</div>
                            <div class="item-slot-content">
                                <span style="font-size: 0.8em; color: #6c757d;">ì•„ì´í…œì„ ì„ íƒí•˜ì„¸ìš”</span>
                            </div>
                            <button class="item-slot-remove" onclick="removeFromSlot('item2')">Ã—</button>
                        </div>
                        <div class="item-slot" data-slot="item3">
                            <div class="item-slot-label">ì•„ì´í…œ 3</div>
                            <div class="item-slot-content">
                                <span style="font-size: 0.8em; color: #6c757d;">ì•„ì´í…œì„ ì„ íƒí•˜ì„¸ìš”</span>
                            </div>
                            <button class="item-slot-remove" onclick="removeFromSlot('item3')">Ã—</button>
                        </div>
                    </div>
                    <div id="itemCategories" class="item-categories"></div>
                </div>

                <!-- ë©”ì‹œì§€ ì…ë ¥ ì„¹ì…˜ -->
                <div class="section">
                    <div class="section-title">ğŸ’¬ í•œì¤„ ë©”ì‹œì§€</div>
                    <textarea id="userMessage" class="message-input" placeholder="í•˜ê³  ì‹¶ì€ ë§ì„ í•œ ì¤„ë¡œ ì ì–´ì£¼ì„¸ìš”..." maxlength="100" rows="3"></textarea>
                    <div class="message-counter">
                        <span id="messageCount">0</span> / 100
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <!-- ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ -->
                <div class="preview-section">
                    <h3 style="margin-bottom: 20px; color: #495057;">ğŸ–¼ï¸ ë¯¸ë¦¬ë³´ê¸°</h3>
                    <div id="previewContainer">
                        <div class="preview-placeholder">
                            ì•„ë°”íƒ€ë¥¼ ì„ íƒí•˜ë©´<br>ì—¬ê¸°ì— ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤
                        </div>
                    </div>
                    <canvas id="avatarCanvas" class="preview-canvas" width="350" height="350" style="display: none;"></canvas>
                    
                    <div class="selected-items">
                        <div id="selectedAvatarInfo"></div>
                        <div id="selectedItemsInfo"></div>
                    </div>
                    
                    <button class="btn btn-success" id="saveCustomization" onclick="saveCustomization()" style="width: 100%; margin-top: 20px;" disabled>
                        ğŸ’¾ ì €ì¥í•˜ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentUserToken = '';
        let avatarCategories = [];
        let itemCategories = [];
        let avatarSelections = {}; // { categoryType: optionId }
        let roleSelection = ''; // role ì•„ì´í…œ ID
        let itemSelections = { item1: '', item2: '', item3: '' }; // ìŠ¬ë¡¯ë³„ ì•„ì´í…œ ID
        let userMessage = '';
        let isLoading = false;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            initializeApp();
        });

        // ì•± ì´ˆê¸°í™”
        function initializeApp() {
            // ì €ì¥ëœ í† í° ë³µì›
            const savedToken = localStorage.getItem('userToken');
            if (savedToken) {
                document.getElementById('userToken').value = savedToken;
                currentUserToken = savedToken;
                showStatus('authStatus', 'success', 'âœ… ì €ì¥ëœ í† í°ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                loadData();
            }

            // ë©”ì‹œì§€ ì¹´ìš´í„° ì„¤ì •
            const messageInput = document.getElementById('userMessage');
            messageInput.addEventListener('input', function() {
                const count = this.value.length;
                document.getElementById('messageCount').textContent = count;
                userMessage = this.value;
                updateSaveButton();
            });

            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
            setupDragAndDrop();
        }

        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // í† í° ì„¤ì •
        function setUserToken() {
            const token = document.getElementById('userToken').value.trim();
            if (!token) {
                showStatus('authStatus', 'error', 'í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            currentUserToken = token;
            localStorage.setItem('userToken', token);
            showStatus('authStatus', 'success', 'âœ… ì‚¬ìš©ì í† í°ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadData();
        }

        // í…ŒìŠ¤íŠ¸ í† í° ìƒì„±
        async function getUserToken() {
            try {
                showStatus('authStatus', 'loading', 'í…ŒìŠ¤íŠ¸ í† í°ì„ ìƒì„±í•˜ëŠ” ì¤‘...');

                const response = await fetch('/api/auth/test-token/002', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    const token = data.token;
                    document.getElementById('userToken').value = token;
                    currentUserToken = token;
                    localStorage.setItem('userToken', token);
                    
                    showStatus('authStatus', 'success', `âœ… í…ŒìŠ¤íŠ¸ í† í°ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. (ì‚¬ìš©ì: ${data.user.nameKr})`);
                    loadData();
                } else {
                    showStatus('authStatus', 'error', `âŒ í† í° ìƒì„± ì‹¤íŒ¨: ${data.message}`);
                }
            } catch (error) {
                console.error('í† í° ìƒì„± ì˜¤ë¥˜:', error);
                showStatus('authStatus', 'error', `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // í† í° ì´ˆê¸°í™”
        function clearUserToken() {
            currentUserToken = '';
            localStorage.removeItem('userToken');
            document.getElementById('userToken').value = '';
            showStatus('authStatus', 'success', 'ğŸ”„ í† í°ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            
            // ë°ì´í„° ì´ˆê¸°í™”
            avatarCategories = [];
            itemCategories = [];
            avatarSelections = {};
            roleSelection = '';
            itemSelections = { item1: '', item2: '', item3: '' };
            
            // UI ì´ˆê¸°í™”
            document.getElementById('avatarCategories').innerHTML = '';
            document.getElementById('roleCategory').innerHTML = '';
            document.getElementById('itemCategories').innerHTML = '';
            updatePreview();
            updateSaveButton();
        }

        // ë°ì´í„° ë¡œë“œ
        async function loadData() {
            if (!currentUserToken) {
                showStatus('authStatus', 'error', 'âŒ ë¨¼ì € ì‚¬ìš©ì í† í°ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                // 1. ì•„ë°”íƒ€ ë° ì•„ì´í…œ ì¹´í…Œê³ ë¦¬ ë¡œë“œ
                await Promise.all([
                    loadAvatarCategories(),
                    loadItemCategories()
                ]);

                // 2. ê¸°ì¡´ ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ (ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì™„ë£Œ í›„)
                await loadUserCustomization();
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ì €ì¥ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateSaveButton() {
            const saveButton = document.getElementById('saveCustomization');
            const hasAvatarSelection = Object.keys(avatarSelections).length > 0;
            const hasToken = !!currentUserToken;
            
            saveButton.disabled = !hasAvatarSelection || !hasToken || isLoading;
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
        function setupDragAndDrop() {
            const slots = document.querySelectorAll('.item-slot');
            
            slots.forEach(slot => {
                slot.addEventListener('dragover', handleDragOver);
                slot.addEventListener('drop', handleDrop);
                slot.addEventListener('dragleave', handleDragLeave);
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            
            const itemId = e.dataTransfer.getData('text/plain');
            const slotType = e.currentTarget.getAttribute('data-slot');
            
            if (itemId && slotType) {
                // ë“œë˜ê·¸ëœ ì•„ì´í…œì˜ íƒ€ì… í™•ì¸
                const draggedItemData = e.dataTransfer.getData('application/json');
                if (draggedItemData) {
                    try {
                        const itemData = JSON.parse(draggedItemData);
                        
                        // Role ì•„ì´í…œì€ Role ìŠ¬ë¡¯ì—ë§Œ, ì¼ë°˜ ì•„ì´í…œì€ ì¼ë°˜ ìŠ¬ë¡¯ì—ë§Œ
                        if (itemData.slotType === 'role' && slotType !== 'role') {
                            alert('âŒ ì—­í•  ì•„ì´í…œì€ ì—­í•  ìŠ¬ë¡¯ì—ë§Œ ë°°ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                            return;
                        }
                        
                        if (itemData.slotType !== 'role' && slotType === 'role') {
                            alert('âŒ ì¼ë°˜ ì•„ì´í…œì€ ì—­í•  ìŠ¬ë¡¯ì— ë°°ì¹˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            return;
                        }
                    } catch (error) {
                        console.error('ë“œë˜ê·¸ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', error);
                    }
                }
                
                addToSlot(slotType, itemId);
            }
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        // ì•„ë°”íƒ€ ì¹´í…Œê³ ë¦¬ ë¡œë“œ
        async function loadAvatarCategories() {
            showStatus('avatarStatus', 'loading', 'ì•„ë°”íƒ€ ì¹´í…Œê³ ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
            
            try {
                const response = await fetch('/api/admin/avatars/categories', {
                    headers: {
                        'Authorization': `Bearer ${currentUserToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    avatarCategories = data.categories.sort((a, b) => (a.order || 0) - (b.order || 0));
                    renderAvatarCategories();
                    showStatus('avatarStatus', 'success', `âœ… ${avatarCategories.length}ê°œì˜ ì•„ë°”íƒ€ ì¹´í…Œê³ ë¦¬ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
                } else {
                    let errorMessage = 'ì•„ë°”íƒ€ ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì‹¤íŒ¨';
                    if (response.status === 401) {
                        errorMessage = 'ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.';
                    } else if (response.status === 403) {
                        errorMessage = 'ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
                    }
                    showStatus('avatarStatus', 'error', `âŒ ${data.message || errorMessage}`);
                }
            } catch (error) {
                console.error('ì•„ë°”íƒ€ ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì˜¤ë¥˜:', error);
                showStatus('avatarStatus', 'error', `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // ì•„ë°”íƒ€ ì¹´í…Œê³ ë¦¬ ë Œë”ë§
        function renderAvatarCategories() {
            const container = document.getElementById('avatarCategories');
            container.innerHTML = '';

            if (avatarCategories.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">ë“±ë¡ëœ ì•„ë°”íƒ€ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            avatarCategories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'avatar-category';
                categoryDiv.innerHTML = `
                    <div class="category-header">
                        <div class="category-name">${category.name}</div>
                        <div class="category-selection" id="selection-${category.type}">ì„ íƒ ì•ˆí•¨</div>
                    </div>
                    <div class="avatar-options" id="options-${category.type}">
                        ${renderAvatarOptions(category.options || [], category.type)}
                    </div>
                `;
                container.appendChild(categoryDiv);
            });
        }

        // ì•„ë°”íƒ€ ì˜µì…˜ ë Œë”ë§
        function renderAvatarOptions(options, categoryType) {
            if (!options || options.length === 0) {
                return '<p style="text-align: center; color: #6c757d; padding: 20px;">ë“±ë¡ëœ ì˜µì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }

            return options.map(option => {
                const optionId = option._id || option.id;
                const isSelected = avatarSelections[categoryType] === optionId;
                
                return `
                    <div class="avatar-option ${isSelected ? 'selected' : ''}" 
                         data-category="${categoryType}" 
                         data-option="${optionId}"
                         onclick="selectAvatarOption('${categoryType}', '${optionId}')">
                        ${option.thumbnailUrl || option.imageUrl ? 
                            `<img src="${option.thumbnailUrl || option.imageUrl}" alt="${option.name}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yOCAzMkM5LjUgMzIgMzIgMTggNDAgMThTNTcuNSAzMiA0MCAzMlMxOC41IDMyIDI4IDMyWiIgZmlsbD0iI0Q1RDhEQyIvPgo8cGF0aCBkPSJNMTYgNjRDMTYgNDkuNSAyNi41IDQwIDQwIDQwUzY0IDQ5LjUgNjQgNjRWNjRIMTZWNjRaIiBmaWxsPSIjRDVEOERDIi8+Cjwvc3ZnPg=='">`
                            : `<div style="width: 100%; height: 80px; background: #f8f9fa; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #6c757d; font-size: 0.8em;">ì´ë¯¸ì§€ ì—†ìŒ</div>`
                        }
                        <div class="avatar-option-name">${option.name}</div>
                    </div>
                `;
            }).join('');
        }

        // ì•„ì´í…œ ì¹´í…Œê³ ë¦¬ ë¡œë“œ
        async function loadItemCategories() {
            showStatus('itemStatus', 'loading', 'ì•„ì´í…œ ì¹´í…Œê³ ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
            showStatus('roleStatus', 'loading', 'ì—­í•  ì•„ì´í…œì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
            
            try {
                const response = await fetch('/api/admin/items/categories', {
                    headers: {
                        'Authorization': `Bearer ${currentUserToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    itemCategories = data.categories.sort((a, b) => (a.order || 0) - (b.order || 0));
                    
                    // Role ì¹´í…Œê³ ë¦¬ì™€ ì¼ë°˜ ì¹´í…Œê³ ë¦¬ ë¶„ë¦¬
                    const roleCategories = itemCategories.filter(cat => cat.type === 'role');
                    const generalCategories = itemCategories.filter(cat => cat.type !== 'role');
                    
                    renderRoleCategory(roleCategories[0]); // Role ì¹´í…Œê³ ë¦¬ëŠ” í•˜ë‚˜ë§Œ ìˆë‹¤ê³  ê°€ì •
                    renderItemCategories(generalCategories);
                    
                    showStatus('itemStatus', 'success', `âœ… ${generalCategories.length}ê°œì˜ ì•„ì´í…œ ì¹´í…Œê³ ë¦¬ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
                    showStatus('roleStatus', 'success', `âœ… ì—­í•  ì•„ì´í…œì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
                } else {
                    let errorMessage = 'ì•„ì´í…œ ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì‹¤íŒ¨';
                    if (response.status === 401) {
                        errorMessage = 'ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.';
                    } else if (response.status === 403) {
                        errorMessage = 'ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
                    }
                    showStatus('itemStatus', 'error', `âŒ ${data.message || errorMessage}`);
                    showStatus('roleStatus', 'error', `âŒ ${data.message || errorMessage}`);
                }
            } catch (error) {
                console.error('ì•„ì´í…œ ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì˜¤ë¥˜:', error);
                showStatus('itemStatus', 'error', `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
                showStatus('roleStatus', 'error', `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // Role ì¹´í…Œê³ ë¦¬ ë Œë”ë§
        function renderRoleCategory(category) {
            const container = document.getElementById('roleCategory');
            container.innerHTML = '';

            if (!category || !category.items || category.items.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">ë“±ë¡ëœ ì—­í•  ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            container.innerHTML = `
                <div class="category-header">
                    <div class="category-name">${category.name}</div>
                </div>
                <div class="item-grid">
                    ${renderItemCards(category.items, 'role')}
                </div>
            `;
        }

        // ì¼ë°˜ ì•„ì´í…œ ì¹´í…Œê³ ë¦¬ ë Œë”ë§
        function renderItemCategories(categories) {
            const container = document.getElementById('itemCategories');
            container.innerHTML = '';

            if (categories.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">ë“±ë¡ëœ ì•„ì´í…œ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'item-category';
                categoryDiv.innerHTML = `
                    <div class="category-header">
                        <div class="category-name">${category.name}</div>
                    </div>
                    <div class="item-grid">
                        ${renderItemCards(category.items || [], 'item')}
                    </div>
                `;
                container.appendChild(categoryDiv);
            });
        }

        // ì•„ì´í…œ ì¹´ë“œ ë Œë”ë§
        function renderItemCards(items, slotType) {
            if (!items || items.length === 0) {
                return '<p style="text-align: center; color: #6c757d; padding: 20px;">ë“±ë¡ëœ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }

            return items.map(item => {
                const itemId = item._id || item.id;
                const imageUrl = item.thumbnailUrl || item.imageUrl;
                
                return `
                    <div class="item-card" 
                         data-item-id="${itemId}" 
                         data-slot-type="${slotType}"
                         draggable="true"
                         ondragstart="handleItemDragStart(event)"
                         onclick="handleItemClick(event, '${itemId}', '${slotType}')">
                        ${imageUrl ? 
                            `<img src="${imageUrl}" alt="${item.name}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjgwIiB2aWV3Qm94PSIwIDAgMTAwIDgwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjRjNGNEY2Ii8+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNDAiIHI9IjE1IiBmaWxsPSIjRDVEOERDIi8+Cjx0ZXh0IHg9IjUwIiB5PSI2NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSIjNkM3NTdEIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5JVEVNPC90ZXh0Pgo8L3N2Zz4K'">`
                            : `<div style="width: 100%; height: 80px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #6c757d; font-size: 0.8em;">ì´ë¯¸ì§€ ì—†ìŒ</div>`
                        }
                        <div class="item-card-name">${item.name}</div>
                    </div>
                `;
            }).join('');
        }

        // ì•„ì´í…œ ë“œë˜ê·¸ ì‹œì‘
        function handleItemDragStart(event) {
            const itemId = event.currentTarget.getAttribute('data-item-id');
            const slotType = event.currentTarget.getAttribute('data-slot-type');
            
            event.dataTransfer.setData('text/plain', itemId);
            event.dataTransfer.setData('application/json', JSON.stringify({
                itemId: itemId,
                slotType: slotType
            }));
        }

        // ì•„ì´í…œ í´ë¦­ ì²˜ë¦¬ (ëª¨ë°”ì¼ ëŒ€ì‘)
        function handleItemClick(event, itemId, slotType) {
            // ë¹ˆ ìŠ¬ë¡¯ ì°¾ê¸°
            let targetSlot = null;
            
            if (slotType === 'role') {
                targetSlot = 'role';
            } else {
                // ì¼ë°˜ ì•„ì´í…œì˜ ê²½ìš° ë¹ˆ ìŠ¬ë¡¯ ì°¾ê¸°
                for (let i = 1; i <= 3; i++) {
                    if (!itemSelections[`item${i}`]) {
                        targetSlot = `item${i}`;
                        break;
                    }
                }
            }
            
            if (targetSlot) {
                addToSlot(targetSlot, itemId);
            } else {
                alert('ì‚¬ìš© ê°€ëŠ¥í•œ ìŠ¬ë¡¯ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ì¡´ ì•„ì´í…œì„ ì œê±°í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        // ì•„ë°”íƒ€ ì˜µì…˜ ì„ íƒ
        function selectAvatarOption(categoryType, optionId) {
            // ì´ì „ ì„ íƒ í•´ì œ
            const prevOption = document.querySelector(`[data-category="${categoryType}"][data-option="${avatarSelections[categoryType]}"]`);
            if (prevOption) {
                prevOption.classList.remove('selected');
            }

            // ìƒˆë¡œìš´ ì„ íƒ
            avatarSelections[categoryType] = optionId;
            
            // UI ì—…ë°ì´íŠ¸
            const newOption = document.querySelector(`[data-category="${categoryType}"][data-option="${optionId}"]`);
            if (newOption) {
                newOption.classList.add('selected');
            }

            // ì¹´í…Œê³ ë¦¬ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
            const selectionElement = document.getElementById(`selection-${categoryType}`);
            if (selectionElement) {
                const category = avatarCategories.find(cat => cat.type === categoryType);
                const option = category?.options?.find(opt => (opt._id || opt.id) === optionId);
                if (option) {
                    selectionElement.textContent = option.name;
                    selectionElement.parentElement.parentElement.classList.add('selected');
                }
            }

            // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            updatePreview();
            updateSaveButton();
        }

        // ìŠ¬ë¡¯ì— ì•„ì´í…œ ì¶”ê°€
        function addToSlot(slotType, itemId) {
            // í•´ë‹¹ ì•„ì´í…œ ì •ë³´ ì°¾ê¸°
            const item = findItemById(itemId);
            if (!item) {
                console.error('Item not found:', itemId);
                return;
            }

            // ìŠ¬ë¡¯ì— ì•„ì´í…œ ì„¤ì •
            if (slotType === 'role') {
                roleSelection = itemId;
            } else {
                itemSelections[slotType] = itemId;
            }

            // ìŠ¬ë¡¯ UI ì—…ë°ì´íŠ¸
            updateSlotUI(slotType, item);
            
            // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            updateSelectedItemsInfo();
            updateSaveButton();
        }

        // ìŠ¬ë¡¯ì—ì„œ ì•„ì´í…œ ì œê±°
        function removeFromSlot(slotType) {
            if (slotType === 'role') {
                roleSelection = '';
            } else {
                itemSelections[slotType] = '';
            }

            // ìŠ¬ë¡¯ UI ì—…ë°ì´íŠ¸
            clearSlotUI(slotType);
            
            // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            updateSelectedItemsInfo();
            updateSaveButton();
        }

        // ìŠ¬ë¡¯ UI ì—…ë°ì´íŠ¸
        function updateSlotUI(slotType, item) {
            const slot = document.querySelector(`[data-slot="${slotType}"]`);
            if (!slot) return;

            const slotContent = slot.querySelector('.item-slot-content');
            if (!slotContent) return;

            const imageUrl = item.thumbnailUrl || item.imageUrl;
            
            slotContent.innerHTML = `
                <img src="${imageUrl}" alt="${item.name}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjNGNEY2Ii8+CjxjaXJjbGUgY3g9IjMwIiBjeT0iMzAiIHI9IjEwIiBmaWxsPSIjRDVEOERDIi8+Cjx0ZXh0IHg9IjMwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjgiIGZpbGw9IiM2Qzc1N0QiIHRleHQtYW5jaG9yPSJtaWRkbGUiPklURU08L3RleHQ+Cjwvc3ZnPgo='">
                <div style="font-size: 0.7em; color: #495057; margin-top: 5px; text-align: center;">${item.name}</div>
            `;
            
            slot.classList.add('filled');
        }

        // ìŠ¬ë¡¯ UI ì´ˆê¸°í™”
        function clearSlotUI(slotType) {
            const slot = document.querySelector(`[data-slot="${slotType}"]`);
            if (!slot) return;

            const slotContent = slot.querySelector('.item-slot-content');
            if (!slotContent) return;

            let defaultText = '';
            if (slotType === 'role') {
                defaultText = 'ì—­í• ì„ ì„ íƒí•˜ì„¸ìš”';
            } else {
                defaultText = 'ì•„ì´í…œì„ ì„ íƒí•˜ì„¸ìš”';
            }

            slotContent.innerHTML = `<span style="font-size: 0.8em; color: #6c757d;">${defaultText}</span>`;
            slot.classList.remove('filled');
        }

        // ì•„ì´í…œ IDë¡œ ì•„ì´í…œ ì°¾ê¸°
        function findItemById(itemId) {
            for (const category of itemCategories) {
                if (category.items) {
                    for (const item of category.items) {
                        if ((item._id || item.id) === itemId) {
                            return item;
                        }
                    }
                }
            }
            return null;
        }

        // ì„ íƒëœ ì•„ì´í…œ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateSelectedItemsInfo() {
            const container = document.getElementById('selectedItemsInfo');
            if (!container) return;

            const selectedItems = [];
            
            // Role ì•„ì´í…œ ì¶”ê°€
            if (roleSelection) {
                const roleItem = findItemById(roleSelection);
                if (roleItem) {
                    selectedItems.push({
                        type: 'role',
                        name: roleItem.name,
                        imageUrl: roleItem.thumbnailUrl || roleItem.imageUrl
                    });
                }
            }

            // ì¼ë°˜ ì•„ì´í…œ ì¶”ê°€
            for (const [slotType, itemId] of Object.entries(itemSelections)) {
                if (itemId) {
                    const item = findItemById(itemId);
                    if (item) {
                        selectedItems.push({
                            type: slotType,
                            name: item.name,
                            imageUrl: item.thumbnailUrl || item.imageUrl
                        });
                    }
                }
            }

            if (selectedItems.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; font-size: 0.9em;">ì„ íƒëœ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            container.innerHTML = selectedItems.map(item => `
                <div class="selected-item">
                    <img src="${item.imageUrl}" alt="${item.name}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAiIGhlaWdodD0iMzAiIHZpZXdCb3g9IjAgMCAzMCAzMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMwIiBoZWlnaHQ9IjMwIiBmaWxsPSIjRjNGNEY2Ii8+CjxjaXJjbGUgY3g9IjE1IiBjeT0iMTUiIHI9IjUiIGZpbGw9IiNENUQ4REMiLz4KPC9zdmc+Cg=='">
                    <div>
                        <strong>${item.type === 'role' ? 'ì—­í• ' : item.type.toUpperCase()}:</strong> ${item.name}
                    </div>
                </div>
            `).join('');
        }

        // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updatePreview() {
            const canvas = document.getElementById('avatarCanvas');
            const previewContainer = document.getElementById('previewContainer');
            const placeholder = previewContainer.querySelector('.preview-placeholder');
            
            // ì•„ë°”íƒ€ ì„ íƒì´ ì—†ìœ¼ë©´ placeholder í‘œì‹œ
            if (Object.keys(avatarSelections).length === 0) {
                if (placeholder) {
                    placeholder.style.display = 'flex';
                }
                canvas.style.display = 'none';
                updateSelectedAvatarInfo();
                return;
            }
            
            // Canvas í‘œì‹œ, placeholder ìˆ¨ê¹€
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            canvas.style.display = 'block';
            
            // ì•„ë°”íƒ€ í•©ì„±
            composeAvatar();
        }

        // ì•„ë°”íƒ€ í•©ì„±
        async function composeAvatar() {
            const canvas = document.getElementById('avatarCanvas');
            const ctx = canvas.getContext('2d');
            
            // Canvas ì´ˆê¸°í™”
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ë°°ê²½ ì„¤ì • (íˆ¬ëª… ë°°ê²½)
            ctx.fillStyle = 'rgba(0, 0, 0, 0)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            try {
                // ì•„ë°”íƒ€ ì¹´í…Œê³ ë¦¬ë¥¼ order ìˆœì„œëŒ€ë¡œ ì •ë ¬
                const sortedCategories = avatarCategories
                    .filter(category => avatarSelections[category.type])
                    .sort((a, b) => (a.order || 0) - (b.order || 0));
                
                // ìˆœì„œëŒ€ë¡œ ì´ë¯¸ì§€ ë ˆì´ì–´ë§
                for (const category of sortedCategories) {
                    const optionId = avatarSelections[category.type];
                    const option = category.options?.find(opt => (opt._id || opt.id) === optionId);
                    
                    if (option && (option.imageUrl || option.thumbnailUrl)) {
                        const imageUrl = option.imageUrl || option.thumbnailUrl;
                        await drawImageOnCanvas(ctx, imageUrl, canvas.width, canvas.height);
                    }
                }
                
                // ì„ íƒëœ ì•„ë°”íƒ€ ì •ë³´ ì—…ë°ì´íŠ¸
                updateSelectedAvatarInfo();
                
            } catch (error) {
                console.error('ì•„ë°”íƒ€ í•©ì„± ì˜¤ë¥˜:', error);
                
                // ì—ëŸ¬ ë°œìƒ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                ctx.fillStyle = '#f8d7da';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#721c24';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨', canvas.width / 2, canvas.height / 2);
                ctx.fillText('ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”', canvas.width / 2, canvas.height / 2 + 25);
            }
        }

        // Canvasì— ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
        function drawImageOnCanvas(ctx, imageUrl, canvasWidth, canvasHeight) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous'; // CORS ë¬¸ì œ í•´ê²°
                
                img.onload = function() {
                    try {
                        // ì´ë¯¸ì§€ë¥¼ Canvas í¬ê¸°ì— ë§ì¶° ê·¸ë¦¬ê¸°
                        const aspectRatio = img.width / img.height;
                        const canvasAspectRatio = canvasWidth / canvasHeight;
                        
                        let drawWidth, drawHeight, drawX, drawY;
                        
                        if (aspectRatio > canvasAspectRatio) {
                            // ì´ë¯¸ì§€ê°€ Canvasë³´ë‹¤ ê°€ë¡œë¡œ ê¸¸ ê²½ìš°
                            drawWidth = canvasWidth;
                            drawHeight = canvasWidth / aspectRatio;
                            drawX = 0;
                            drawY = (canvasHeight - drawHeight) / 2;
                        } else {
                            // ì´ë¯¸ì§€ê°€ Canvasë³´ë‹¤ ì„¸ë¡œë¡œ ê¸¸ ê²½ìš°
                            drawWidth = canvasHeight * aspectRatio;
                            drawHeight = canvasHeight;
                            drawX = (canvasWidth - drawWidth) / 2;
                            drawY = 0;
                        }
                        
                        ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                };
                
                img.onerror = function() {
                    reject(new Error(`ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: ${imageUrl}`));
                };
                
                img.src = imageUrl;
            });
        }

        // ì„ íƒëœ ì•„ë°”íƒ€ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateSelectedAvatarInfo() {
            const container = document.getElementById('selectedAvatarInfo');
            if (!container) return;

            const selectedAvatars = [];
            
            for (const [categoryType, optionId] of Object.entries(avatarSelections)) {
                const category = avatarCategories.find(cat => cat.type === categoryType);
                const option = category?.options?.find(opt => (opt._id || opt.id) === optionId);
                
                if (option) {
                    selectedAvatars.push({
                        categoryName: category.name,
                        optionName: option.name,
                        imageUrl: option.thumbnailUrl || option.imageUrl
                    });
                }
            }

            if (selectedAvatars.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; font-size: 0.9em;">ì„ íƒëœ ì•„ë°”íƒ€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #495057; font-size: 1em;">ì„ íƒëœ ì•„ë°”íƒ€</h4>
                    ${selectedAvatars.map(avatar => `
                        <div class="selected-item">
                            <img src="${avatar.imageUrl}" alt="${avatar.optionName}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAiIGhlaWdodD0iMzAiIHZpZXdCb3g9IjAgMCAzMCAzMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMwIiBoZWlnaHQ9IjMwIiBmaWxsPSIjRjNGNEY2Ii8+CjxjaXJjbGUgY3g9IjE1IiBjeT0iMTUiIHI9IjUiIGZpbGw9IiNENUQ4REMiLz4KPC9zdmc+Cg=='">
                            <div>
                                <strong>${avatar.categoryName}:</strong> ${avatar.optionName}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Canvasì—ì„œ Blob ìƒì„±
        function getCanvasBlob() {
            return new Promise((resolve, reject) => {
                const canvas = document.getElementById('avatarCanvas');
                
                canvas.toBlob(
                    (blob) => {
                        if (blob) {
                            resolve(blob);
                        } else {
                            reject(new Error('Canvas to Blob ë³€í™˜ ì‹¤íŒ¨'));
                        }
                    },
                    'image/png',
                    0.9
                );
            });
        }

        // ì»¤ìŠ¤í„°ë§ˆì´ì§• ì €ì¥
        async function saveCustomization() {
            if (!currentUserToken) {
                alert('âŒ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¨¼ì € í† í°ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (Object.keys(avatarSelections).length === 0) {
                alert('âŒ ì•„ë°”íƒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const saveButton = document.getElementById('saveCustomization');
            const originalText = saveButton.textContent;
            
            try {
                isLoading = true;
                saveButton.disabled = true;
                saveButton.innerHTML = '<div class="loading-spinner" style="width: 20px; height: 20px; margin: 0 auto;"></div>';

                // 1. í•©ì„±ëœ ì•„ë°”íƒ€ ì´ë¯¸ì§€ ì—…ë¡œë“œ
                let avatarImgUrl = '';
                if (Object.keys(avatarSelections).length > 0) {
                    const blob = await getCanvasBlob();
                    avatarImgUrl = await uploadAvatarImage(blob);
                }

                // 2. ì‚¬ìš©ì ì»¤ìŠ¤í„°ë§ˆì´ì§• ë°ì´í„° ì €ì¥
                const customizationData = {
                    avatarSelections: avatarSelections,
                    avatarImgUrl: avatarImgUrl,
                    message: userMessage || '',
                    role: roleSelection || '',
                    item1: itemSelections.item1 || '',
                    item2: itemSelections.item2 || '',
                    item3: itemSelections.item3 || ''
                };

                await saveUserCustomization(customizationData);

                // ì„±ê³µ ë©”ì‹œì§€
                alert('âœ… ì»¤ìŠ¤í„°ë§ˆì´ì§•ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                alert(`âŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            } finally {
                isLoading = false;
                saveButton.disabled = false;
                saveButton.textContent = originalText;
                updateSaveButton();
            }
        }

        // ì•„ë°”íƒ€ ì´ë¯¸ì§€ ì—…ë¡œë“œ
        async function uploadAvatarImage(blob) {
            const formData = new FormData();
            formData.append('avatar', blob, 'avatar.png');
            
            // ì‚¬ìš©ì ID ì¶”ì¶œ (JWT í† í°ì—ì„œ ì¶”ì¶œí•˜ê±°ë‚˜ ì„ì‹œë¡œ ì„¤ì •)
            const userId = extractUserIdFromToken(currentUserToken) || 'temp-user-id';
            formData.append('userId', userId);

            const response = await fetch('/api/avatars/upload', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${currentUserToken}`
                },
                body: formData
            });

            const data = await response.json();

            if (response.ok) {
                return data.avatarImgUrl;
            } else {
                throw new Error(data.error || 'ì•„ë°”íƒ€ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨');
            }
        }

        // ì‚¬ìš©ì ì»¤ìŠ¤í„°ë§ˆì´ì§• ë°ì´í„° ì €ì¥
        async function saveUserCustomization(customizationData) {
            // ì‚¬ìš©ì ID ì¶”ì¶œ
            const userId = extractUserIdFromToken(currentUserToken) || 'temp-user-id';

            const response = await fetch(`/api/avatars/${userId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${currentUserToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(customizationData)
            });

            const data = await response.json();

            if (!response.ok) {
                console.error('Server error response:', data);
                console.error('Request data:', customizationData);
                throw new Error(data.error || data.message || 'ì‚¬ìš©ì ë°ì´í„° ì €ì¥ ì‹¤íŒ¨');
            }

            return data;
        }

        // JWT í† í°ì—ì„œ ì‚¬ìš©ì ID ì¶”ì¶œ (ê°„ë‹¨í•œ êµ¬í˜„)
        function extractUserIdFromToken(token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                return payload.userId || payload.id || payload.sub;
            } catch (error) {
                console.error('í† í° íŒŒì‹± ì˜¤ë¥˜:', error);
                return null;
            }
        }

        // ê¸°ì¡´ ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ
        async function loadUserCustomization() {
            if (!currentUserToken) return;

            try {
                const userId = extractUserIdFromToken(currentUserToken) || 'temp-user-id';
                
                const response = await fetch(`/api/avatars/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${currentUserToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // ê¸°ì¡´ ë°ì´í„°ë¡œ UI ë³µì›
                    if (data.avatarSelections) {
                        avatarSelections = data.avatarSelections;
                    }
                    if (data.message) {
                        userMessage = data.message;
                        document.getElementById('userMessage').value = data.message;
                        document.getElementById('messageCount').textContent = data.message.length;
                    }
                    if (data.role) {
                        roleSelection = data.role;
                    }
                    if (data.item1) {
                        itemSelections.item1 = data.item1;
                    }
                    if (data.item2) {
                        itemSelections.item2 = data.item2;
                    }
                    if (data.item3) {
                        itemSelections.item3 = data.item3;
                    }

                    // UI ì—…ë°ì´íŠ¸
                    updateUIFromLoadedData();
                    console.log('ê¸°ì¡´ ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
                } else if (response.status === 404) {
                    // 404ëŠ” ì •ìƒì ì¸ ìƒí™© - ì‚¬ìš©ì ë°ì´í„°ê°€ ì—†ìŒ
                    console.log('ìƒˆë¡œìš´ ì‚¬ìš©ì - ê¸°ì¡´ ë°ì´í„° ì—†ìŒ');
                } else {
                    // ë‹¤ë¥¸ ì˜¤ë¥˜ë“¤ë§Œ ë¡œê¹…
                    console.warn('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ë¡œë“œëœ ë°ì´í„°ë¡œ UI ì—…ë°ì´íŠ¸
        function updateUIFromLoadedData() {
            // ì•„ë°”íƒ€ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
            for (const [categoryType, optionId] of Object.entries(avatarSelections)) {
                const option = document.querySelector(`[data-category="${categoryType}"][data-option="${optionId}"]`);
                if (option) {
                    option.classList.add('selected');
                    
                    const selectionElement = document.getElementById(`selection-${categoryType}`);
                    if (selectionElement) {
                        const category = avatarCategories.find(cat => cat.type === categoryType);
                        const optionData = category?.options?.find(opt => (opt._id || opt.id) === optionId);
                        if (optionData) {
                            selectionElement.textContent = optionData.name;
                            selectionElement.parentElement.parentElement.classList.add('selected');
                        }
                    }
                }
            }

            // ì•„ì´í…œ ìŠ¬ë¡¯ ì—…ë°ì´íŠ¸
            if (roleSelection) {
                const roleItem = findItemById(roleSelection);
                if (roleItem) {
                    updateSlotUI('role', roleItem);
                }
            }

            for (const [slotType, itemId] of Object.entries(itemSelections)) {
                if (itemId) {
                    const item = findItemById(itemId);
                    if (item) {
                        updateSlotUI(slotType, item);
                    }
                }
            }

            // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            updatePreview();
            updateSelectedItemsInfo();
            updateSaveButton();
        }
    </script>
</body>

</html>