<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìºë¦­í„° ì˜µì…˜ ê´€ë¦¬ í…ŒìŠ¤íŠ¸ - AR ëª…í•¨ (ìƒˆ ì»¬ëŸ¬ ì˜µì…˜)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .auth-section {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
            align-items: center;
        }

        input,
        select,
        textarea {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="color"],
        textarea {
            width: 200px;
        }

        input[type="file"] {
            width: 300px;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .btn-success {
            background-color: #28a745;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: #dc3545;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .status.loading {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
        }

        .status.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
        }

        .category-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: white;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .category-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
        }

        .category-title::before {
            content: 'â–¶';
            font-size: 12px;
            margin-right: 10px;
            transition: transform 0.2s;
        }

        .category-card:not(.collapsed) .category-title::before {
            transform: rotate(90deg);
        }

        .category-card.collapsed .category-options {
            display: none;
        }

        .modal {
            display: none !important;
            position: fixed !important;
            z-index: 9999 !important;
            left: 0 !important;
            top: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background-color: rgba(0, 0, 0, 0.5) !important;
        }

        .modal.show {
            display: block !important;
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin: 15px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            box-sizing: border-box;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .option-card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            background: #fafafa;
        }

        .option-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 50%;
            margin-bottom: 10px;
        }

        .option-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .option-actions {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-top: 10px;
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .thumbnail-source {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .category-options {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        /* ì»¬ëŸ¬ ì˜µì…˜ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .color-option-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f9f9f9;
        }

        .color-option-preview {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 10px;
        }

        .palette-preview {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 50%;
            margin-top: 5px;
        }

        .color-options-display {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .color-option-display {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 15px;
            font-size: 12px;
        }

        .color-option-display img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
        }

        .color-option-display .palette-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ¨ ìºë¦­í„° ì˜µì…˜ ê´€ë¦¬ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ (ìƒˆ ì»¬ëŸ¬ ì˜µì…˜)</h1>

        <!-- ì¸ì¦ ì„¹ì…˜ -->
        <div class="section auth-section">
            <h3>ğŸ” ê´€ë¦¬ì ì¸ì¦</h3>
            <p>ìºë¦­í„° ì˜µì…˜ ê´€ë¦¬ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            <div class="controls">
                <input type="text" id="adminToken" placeholder="ê´€ë¦¬ì JWT í† í° ì…ë ¥" style="width: 400px;">
                <button onclick="setAuthToken()">í† í° ì„¤ì •</button>
                <button onclick="getAdminToken()" class="btn-success">ê´€ë¦¬ì í† í° ìƒì„±</button>
                <button onclick="clearAuthToken()" class="btn-secondary">í† í° ì´ˆê¸°í™”</button>
            </div>
            <div id="authStatus"></div>
        </div>

        <!-- ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ ì„¹ì…˜ -->
        <div class="section">
            <h3>ğŸ“ ìºë¦­í„° ì˜µì…˜ ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h3>
            <div class="controls">
                <button onclick="openCreateCategoryModal()" class="btn-success">ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
                <button onclick="loadCategories()" class="btn-secondary">ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div id="categoryStatus"></div>
            <div id="categoriesContainer"></div>
        </div>
    </div>

    <!-- ì¹´í…Œê³ ë¦¬ ìƒì„±/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCategoryModal()">&times;</span>
            <h3 id="categoryModalTitle">ğŸ“ ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</h3>
            <form id="categoryForm">
                <input type="hidden" id="categoryId">

                <div class="form-row">
                    <div class="form-group">
                        <label for="categoryName">ì¹´í…Œê³ ë¦¬ ì´ë¦„ *</label>
                        <input type="text" id="categoryName" required placeholder="ì˜ˆ: ì–¼êµ´í˜•, ëˆˆ, ì½”, ì…">
                    </div>

                    <div class="form-group">
                        <label for="categoryType">ì¹´í…Œê³ ë¦¬ íƒ€ì… *</label>
                        <input type="text" id="categoryType" required placeholder="ì˜ˆ: face, eyes, nose, mouth">
                    </div>
                </div>

                <div class="form-group">
                    <label for="categoryOrder">ìˆœì„œ</label>
                    <input type="number" id="categoryOrder" min="0" value="0">
                </div>

                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" onclick="closeCategoryModal()" class="btn-secondary">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-success">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ìºë¦­í„° ì˜µì…˜ ìƒì„±/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="optionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeOptionModal()">&times;</span>
            <h3 id="optionModalTitle">ğŸ­ ìƒˆ ìºë¦­í„° ì˜µì…˜ ì¶”ê°€</h3>
            <form id="optionForm" enctype="multipart/form-data">
                <input type="hidden" id="optionCategoryId">
                <input type="hidden" id="optionId">

                <div class="form-row">
                    <div class="form-group">
                        <label for="optionName">ì˜µì…˜ ì´ë¦„ *</label>
                        <input type="text" id="optionName" required placeholder="ì˜ˆ: ë‘¥ê·¼ ì–¼êµ´, ë‚ ì¹´ë¡œìš´ ëˆˆ">
                    </div>

                    <div class="form-group">
                        <label for="optionOrder">ìˆœì„œ</label>
                        <input type="number" id="optionOrder" min="0" value="0">
                    </div>
                </div>

                <!-- ì»¬ëŸ¬ ì˜µì…˜ ê´€ë¦¬ ì„¹ì…˜ -->
                <div class="form-group">
                    <label>ì»¬ëŸ¬ ì˜µì…˜ ê´€ë¦¬ *</label>
                    <small>ì²« ë²ˆì§¸ ì»¬ëŸ¬ ì˜µì…˜ì˜ ì´ë¯¸ì§€ê°€ ë©”ì¸ ì´ë¯¸ì§€ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.</small>
                    <div id="colorOptionsContainer">
                        <!-- ì»¬ëŸ¬ ì˜µì…˜ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                    <button type="button" onclick="addColorOption()" class="btn-success" style="margin-top: 10px;">ì»¬ëŸ¬ ì˜µì…˜
                        ì¶”ê°€</button>
                </div>

                <div class="form-group">
                    <label for="optionThumbnail">ì¸ë„¤ì¼ ì´ë¯¸ì§€ (300x300px ê¶Œì¥)</label>
                    <input type="file" id="optionThumbnail" accept="image/*">
                    <small>ì¸ë„¤ì¼ì„ ì œê³µí•˜ì§€ ì•Šìœ¼ë©´ ì²« ë²ˆì§¸ ë¦¬ì†ŒìŠ¤ ì´ë¯¸ì§€ì—ì„œ ìë™ ìƒì„±ë©ë‹ˆë‹¤.</small>
                    <div id="thumbnailPreview"></div>
                </div>

                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" onclick="closeOptionModal()" class="btn-secondary">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-success" id="submitOptionBtn">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentToken = '';
        let categories = [];
        let expandedCategories = new Set();
        let colorOptionIndex = 0;

        // ì¸ì¦ í† í° ì„¤ì •
        function setAuthToken() {
            const token = document.getElementById('adminToken').value.trim();
            if (!token) {
                showStatus('authStatus', 'error', 'í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            currentToken = token;
            localStorage.setItem('adminToken', token);
            showStatus('authStatus', 'success', 'âœ… ê´€ë¦¬ì í† í°ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');

            loadCategories();
        }

        // ê´€ë¦¬ì í† í° ìƒì„±
        async function getAdminToken() {
            try {
                showStatus('authStatus', 'loading', 'ê´€ë¦¬ì í† í°ì„ ìƒì„±í•˜ëŠ” ì¤‘...');

                const response = await fetch('/api/auth/test-token/001', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    const token = data.token;
                    document.getElementById('adminToken').value = token;
                    currentToken = token;
                    localStorage.setItem('adminToken', token);

                    showStatus('authStatus', 'success', `âœ… ê´€ë¦¬ì í† í°ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. (ì‚¬ìš©ì: ${data.user.nameKr})`);

                    loadCategories();
                } else {
                    showStatus('authStatus', 'error', `âŒ í† í° ìƒì„± ì‹¤íŒ¨: ${data.message || 'ê´€ë¦¬ì ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}`);
                }

            } catch (error) {
                console.error('í† í° ìƒì„± ì˜¤ë¥˜:', error);
                showStatus('authStatus', 'error', `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // í† í° ì´ˆê¸°í™”
        function clearAuthToken() {
            currentToken = '';
            localStorage.removeItem('adminToken');
            document.getElementById('adminToken').value = '';
            showStatus('authStatus', 'success', 'ğŸ”„ í† í°ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');

            document.getElementById('categoriesContainer').innerHTML = '';
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ í† í° ë³µì›
        window.addEventListener('load', function () {
            const savedToken = localStorage.getItem('adminToken');
            if (savedToken) {
                document.getElementById('adminToken').value = savedToken;
                currentToken = savedToken;
                showStatus('authStatus', 'success', 'âœ… ì €ì¥ëœ í† í°ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                loadCategories();
            }
        });

        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // ì¹´í…Œê³ ë¦¬ ëª©ë¡ ë¡œë“œ
        async function loadCategories() {
            if (!currentToken) {
                showStatus('categoryStatus', 'error', 'âŒ ë¨¼ì € ê´€ë¦¬ì í† í°ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                showStatus('categoryStatus', 'loading', 'ì¹´í…Œê³ ë¦¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');

                const response = await fetch('/api/admin/characters/categories', {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    categories = data.categories;
                    renderCategories();
                    showStatus('categoryStatus', 'success', `âœ… ${categories.length}ê°œì˜ ì¹´í…Œê³ ë¦¬ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
                } else {
                    showStatus('categoryStatus', 'error', `âŒ ${data.message || 'ì¹´í…Œê³ ë¦¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨'}`);
                }

            } catch (error) {
                console.error('ì¹´í…Œê³ ë¦¬ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                showStatus('categoryStatus', 'error', `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // ì¹´í…Œê³ ë¦¬ ë Œë”ë§
        function renderCategories() {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '';

            if (categories.length === 0) {
                container.innerHTML = '<p>ë“±ë¡ëœ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            categories.forEach(category => {
                const categoryId = category._id || category.id;
                const categoryCard = document.createElement('div');
                const isExpanded = expandedCategories.has(categoryId);
                categoryCard.className = `category-card ${isExpanded ? '' : 'collapsed'}`;
                categoryCard.setAttribute('data-category-id', categoryId);
                categoryCard.innerHTML = `
                    <div class="category-header" onclick="toggleCategory(this)">
                        <div class="category-title">${category.name} (${category.type})</div>
                        <div>
                            <button onclick="event.stopPropagation(); openCreateOptionModal('${categoryId}')" class="btn-success" style="padding: 5px 10px; font-size: 12px;">ì˜µì…˜ ì¶”ê°€</button>
                            <button onclick="event.stopPropagation(); editCategory('${categoryId}')" class="btn-warning" style="padding: 5px 10px; font-size: 12px;">ìˆ˜ì •</button>
                            <button onclick="event.stopPropagation(); deleteCategory('${categoryId}')" class="btn-danger" style="padding: 5px 10px; font-size: 12px;">ì‚­ì œ</button>
                        </div>
                    </div>
                    <div class="category-options">
                        <p><strong>ì˜µì…˜ ìˆ˜:</strong> ${category.options ? category.options.length : 0}ê°œ</p>
                        <div class="options-grid" id="options-${categoryId}">
                            ${renderOptions(category.options || [], categoryId)}
                        </div>
                    </div>
                `;
                container.appendChild(categoryCard);
            });
        }

        function toggleCategory(headerElement) {
            const card = headerElement.closest('.category-card');
            const categoryId = card.getAttribute('data-category-id');

            card.classList.toggle('collapsed');

            if (card.classList.contains('collapsed')) {
                expandedCategories.delete(categoryId);
            } else {
                expandedCategories.add(categoryId);
            }
        }

        // ì˜µì…˜ ë Œë”ë§
        function renderOptions(options, categoryId) {
            if (!options || options.length === 0) {
                return '<p>ë“±ë¡ëœ ì˜µì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }

            return options.map(option => {
                const optionId = option._id || option.id;
                const colorOptionsDisplay = option.color && Array.isArray(option.color) ?
                    `<div class="color-options-display">
                        ${option.color.map(colorOpt => {
                        const imageUrl = colorOpt.paletteImageUrl || colorOpt.imageUrl;
                        return `<div class="color-option-display">
                                <img src="${imageUrl}" alt="${colorOpt.colorName}" class="palette-circle">
                            </div>`;
                    }).join('')}
                    </div>` :
                    '<div style="font-size: 12px; color: #666;">ì»¬ëŸ¬ ì˜µì…˜ ì—†ìŒ</div>';

                return `
                    <div class="option-card">
                        <div class="option-image-container">
                            ${option.thumbnailUrl ? `<img src="${option.thumbnailUrl}" alt="${option.name}" class="option-image">` : '<div class="option-image" style="background-color: #ddd; display: flex; align-items: center; justify-content: center;">ì¸ë„¤ì¼ ì—†ìŒ</div>'}
                        </div>
                        <div class="option-name">${option.name}</div>
                        ${colorOptionsDisplay}
                        <div class="thumbnail-source">ì¸ë„¤ì¼: ${option.thumbnailSource === 'user' ? 'ì‚¬ìš©ì ì œê³µ' : 'ìë™ ìƒì„±'}</div>
                        <div class="option-actions">
                            <button onclick="openEditOptionModal('${categoryId}', '${optionId}', '${option.name}')" class="btn-warning" style="padding: 3px 8px; font-size: 11px;">ìˆ˜ì •</button>
                            <button onclick="deleteOption('${categoryId}', '${optionId}')" class="btn-danger" style="padding: 3px 8px; font-size: 11px;">ì‚­ì œ</button>
                            <button onclick="regenerateThumbnail('${categoryId}', '${optionId}')" class="btn-secondary" style="padding: 3px 8px; font-size: 11px;">ì¸ë„¤ì¼ ì¬ìƒì„±</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ì»¬ëŸ¬ ì˜µì…˜ ì¶”ê°€
        function addColorOption() {
            colorOptionIndex++;
            const container = document.getElementById('colorOptionsContainer');
            const colorOptionDiv = document.createElement('div');
            colorOptionDiv.className = 'color-option-item';
            colorOptionDiv.setAttribute('data-index', colorOptionIndex);
            
            // í˜„ì¬ ì¹´í…Œê³ ë¦¬ í™•ì¸
            const categoryId = document.getElementById('optionCategoryId').value;
            const category = categories.find(c => (c._id || c.id) === categoryId);
            const isHairCategory = category && category.type === 'hair';
            
            // hair ì¹´í…Œê³ ë¦¬ìš© ì¶”ê°€ í•„ë“œ
            const hairFields = isHairCategory ? `
                <div class="form-group hair-resource-group" style="border: 2px dashed #e74c3c; padding: 15px; border-radius: 5px; background: #fef5f5;">
                    <label>ğŸ’‡â€â™€ï¸ ì¤‘ê°„ë¨¸ë¦¬ ì´ë¯¸ì§€ (í•„ìˆ˜) *</label>
                    <input type="file" class="hair-middle-image" accept="image/*" onchange="previewHairResourceImage(this, 'middle')">
                    <div class="hair-middle-preview"></div>
                </div>
                <div class="form-group hair-resource-group" style="border: 2px dashed #3498db; padding: 15px; border-radius: 5px; background: #f0f8ff;">
                    <label>ğŸ’‡â€â™€ï¸ ë’·ë¨¸ë¦¬ ì´ë¯¸ì§€ (ì„ íƒ)</label>
                    <input type="file" class="hair-back-image" accept="image/*" onchange="previewHairResourceImage(this, 'back')">
                    <div class="hair-back-preview"></div>
                    <small style="color: #666;">ì—†ìœ¼ë©´ ì¤‘ê°„ë¨¸ë¦¬ë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤</small>
                </div>
            ` : '';

            colorOptionDiv.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>ì»¬ëŸ¬ ì´ë¦„ *</label>
                        <input type="text" class="color-name" placeholder="ì˜ˆ: ë¹¨ê°•, íŒŒë‘" required>
                    </div>
                    <div class="form-group">
                        <label>ì»¬ëŸ¬ íŒ”ë ˆíŠ¸ (128x128)</label>
                        <input type="file" class="palette-image" accept="image/*" onchange="previewPaletteImage(this)">
                        <small>íŒ”ë ˆíŠ¸ ì´ë¯¸ì§€ë¥¼ ì„¤ì •í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ ì´ë¯¸ì§€ë¥¼ ë™ê·¸ë—ê²Œ í‘œì‹œí•©ë‹ˆë‹¤.</small>
                        <div class="palette-preview-container"></div>
                    </div>
                    ${!isHairCategory ? `
                    <div class="form-group">
                        <label>ë¦¬ì†ŒìŠ¤ ì´ë¯¸ì§€ íŒŒì¼ *</label>
                        <input type="file" class="color-image" accept="image/*" required onchange="previewColorImage(this)">
                        <div class="color-preview"></div>
                    </div>
                    ` : `
                    <div class="form-group" style="background: #fff3cd; padding: 10px; border-radius: 5px; border: 1px solid #ffeaa7;">
                        <div style="color: #856404; font-size: 14px;">
                            ğŸ’¡ <strong>Hair ì¹´í…Œê³ ë¦¬ ì•ˆë‚´:</strong><br>
                            ì¤‘ê°„ë¨¸ë¦¬ ì´ë¯¸ì§€ê°€ ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ìë™ ì„¤ì •ë©ë‹ˆë‹¤.<br>
                            ë³„ë„ì˜ ê¸°ë³¸ ì´ë¯¸ì§€ ì—…ë¡œë“œëŠ” ë¶ˆí•„ìš”í•©ë‹ˆë‹¤.
                        </div>
                    </div>
                    `}
                    
                    ${hairFields}
                    
                    <div class="form-group" style="width: auto;">
                        <button type="button" onclick="removeColorOption(${colorOptionIndex})" class="btn-danger" style="margin-top: 24px;">ì‚­ì œ</button>
                    </div>
                </div>
            `;
            container.appendChild(colorOptionDiv);
        }

        // ì»¬ëŸ¬ ì˜µì…˜ ì‚­ì œ
        function removeColorOption(index) {
            const colorOption = document.querySelector(`[data-index="${index}"]`);
            if (colorOption) {
                colorOption.remove();
            }

            // ìµœì†Œ í•˜ë‚˜ì˜ ì»¬ëŸ¬ ì˜µì…˜ì€ ìœ ì§€
            const remainingOptions = document.querySelectorAll('.color-option-item');
            if (remainingOptions.length === 0) {
                addColorOption();
            }
        }

        // ì»¬ëŸ¬ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
        function previewColorImage(input) {
            const previewDiv = input.parentNode.querySelector('.color-preview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    previewDiv.innerHTML = `<img src="${e.target.result}" alt="ë¯¸ë¦¬ë³´ê¸°" class="color-option-preview">`;
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                previewDiv.innerHTML = '';
            }
        }

        // Hair ë¦¬ì†ŒìŠ¤ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
        function previewHairResourceImage(input, type) {
            const file = input.files[0];
            const colorOption = input.closest('.color-option-item');
            const preview = colorOption.querySelector(`.hair-${type}-preview`);
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="${type === 'middle' ? 'ì¤‘ê°„ë¨¸ë¦¬' : 'ë’·ë¨¸ë¦¬'} ë¯¸ë¦¬ë³´ê¸°" 
                             style="max-width: 60px; max-height: 60px; border-radius: 3px; border: 1px solid #ddd; margin-top: 5px;">
                        <br><small style="color: #666;">${file.name}</small>
                    `;
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = '';
            }
        }

        // íŒ”ë ˆíŠ¸ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
        function previewPaletteImage(input) {
            const previewContainer = input.parentNode.querySelector('.palette-preview-container');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    previewContainer.innerHTML = `<img src="${e.target.result}" alt="íŒ”ë ˆíŠ¸ ë¯¸ë¦¬ë³´ê¸°" class="palette-circle" style="width: 64px; height: 64px; border-radius: 50%; object-fit: cover; margin-top: 5px;">`;
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                previewContainer.innerHTML = '';
            }
        }

        // ì»¬ëŸ¬ ì˜µì…˜ ë°ì´í„° ìˆ˜ì§‘
        function collectColorOptions() {
            const colorOptions = [];
            const colorOptionItems = document.querySelectorAll('.color-option-item');
            
            console.log(`ğŸ” collectColorOptions ì‹œì‘ - ì´ ${colorOptionItems.length}ê°œ ì˜µì…˜ ì•„ì´í…œ ë°œê²¬`);
            
            // ì¹´í…Œê³ ë¦¬ íƒ€ì… í™•ì¸
            const categoryId = document.getElementById('optionCategoryId').value;
            const category = categories.find(c => (c._id || c.id) === categoryId);
            const isHairCategory = category && category.type === 'hair';

            colorOptionItems.forEach((item, index) => {
                const colorName = item.querySelector('.color-name').value.trim();
                // Hair ì¹´í…Œê³ ë¦¬ê°€ ì•„ë‹Œ ê²½ìš°ë§Œ ê¸°ë³¸ ì´ë¯¸ì§€ íŒŒì¼ ìˆ˜ì§‘
                const imageFile = !isHairCategory ? item.querySelector('.color-image')?.files[0] : null;
                const paletteFile = item.querySelector('.palette-image').files[0];
                const existingImageUrl = item.getAttribute('data-image-url'); // ìˆ˜ì • ëª¨ë“œìš©
                const existingPaletteUrl = item.getAttribute('data-palette-url'); // ìˆ˜ì • ëª¨ë“œìš©
                
                // ê¸°ì¡´ resourceImages ë°ì´í„° í™•ì¸ (ìˆ˜ì • ëª¨ë“œìš©)
                let existingResourceImages = null;
                if (isHairCategory) {
                    const middlePreview = item.querySelector('.hair-middle-preview img');
                    const backPreview = item.querySelector('.hair-back-preview img');
                    if (middlePreview || backPreview) {
                        existingResourceImages = {};
                        if (middlePreview) existingResourceImages.hairMiddleImageUrl = middlePreview.src;
                        if (backPreview) existingResourceImages.hairBackImageUrl = backPreview.src;
                    }
                }

                // hair ì¹´í…Œê³ ë¦¬ì¸ ê²½ìš° ì¶”ê°€ ê²€ì¦ ë° ë°ì´í„° ìˆ˜ì§‘
                let hairMiddleFile = null;
                let hairBackFile = null;
                
                if (isHairCategory) {
                    const middleInput = item.querySelector('.hair-middle-image');
                    const backInput = item.querySelector('.hair-back-image');
                    
                    console.log(`ğŸ” Hair ë””ë²„ê¹… - ì»¬ëŸ¬ ${index}:`, {
                        colorName,
                        middleInput: middleInput ? 'found' : 'not found',
                        backInput: backInput ? 'found' : 'not found',
                        middleFiles: middleInput?.files?.length || 0,
                        backFiles: backInput?.files?.length || 0
                    });
                    
                    hairMiddleFile = middleInput?.files[0];
                    hairBackFile = backInput?.files[0];
                    
                    // ì¤‘ê°„ë¨¸ë¦¬ í•„ìˆ˜ ê²€ì¦ (ìƒˆë¡œ ì¶”ê°€í•˜ëŠ” ê²½ìš°ë§Œ)
                    if (!hairMiddleFile && !existingResourceImages) {
                        throw new Error(`ì»¬ëŸ¬ ì˜µì…˜ "${colorName}"ì— ì¤‘ê°„ë¨¸ë¦¬ ì´ë¯¸ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.`);
                    }
                }

                // Hair ì¹´í…Œê³ ë¦¬: colorName + ì¤‘ê°„ë¨¸ë¦¬ íŒŒì¼ì´ ìˆìœ¼ë©´ ë¨
                // ì¼ë°˜ ì¹´í…Œê³ ë¦¬: colorName + (imageFile || existingImageUrl) í•„ìš”
                const isValidColorOption = colorName && (
                    isHairCategory ? (hairMiddleFile || existingResourceImages) : (imageFile || existingImageUrl)
                );
                
                // ë””ë²„ê¹… ë¡œê·¸
                if (isHairCategory) {
                    console.log(`ğŸ” Hair ì˜µì…˜ ê²€ì¦ - ì»¬ëŸ¬ ${index}:`, {
                        colorName,
                        hasMiddleFile: !!hairMiddleFile,
                        hasExistingData: !!existingResourceImages,
                        isValid: isValidColorOption
                    });
                }
                
                if (isValidColorOption) {
                    const colorOption = {
                        colorName: colorName,
                        imageFile: imageFile,
                        paletteFile: paletteFile,
                        imageUrl: existingImageUrl,
                        paletteImageUrl: existingPaletteUrl
                    };
                    
                    console.log(`ğŸ” ìœ íš¨í•œ ì»¬ëŸ¬ ì˜µì…˜ ìƒì„± - ì»¬ëŸ¬ ${index}:`, {
                        colorName,
                        hasImageFile: !!imageFile,
                        hasPaletteFile: !!paletteFile,
                        hasExistingImageUrl: !!existingImageUrl,
                        hasExistingPaletteUrl: !!existingPaletteUrl,
                        paletteFileName: paletteFile?.name
                    });
                    
                    // hair ì¹´í…Œê³ ë¦¬ì¸ ê²½ìš° hair íŒŒì¼ë“¤ ë° ê¸°ì¡´ ë°ì´í„° ì¶”ê°€
                    if (isHairCategory) {
                        colorOption.hairMiddleFile = hairMiddleFile;
                        colorOption.hairBackFile = hairBackFile;
                        if (existingResourceImages) {
                            colorOption.resourceImages = existingResourceImages;
                        }
                    }
                    
                    colorOptions.push(colorOption);
                } else {
                    console.log(`âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ì»¬ëŸ¬ ì˜µì…˜ - ì»¬ëŸ¬ ${index}:`, {
                        colorName,
                        hasImageFile: !!imageFile,
                        hasExistingImageUrl: !!existingImageUrl,
                        hasMiddleFile: !!hairMiddleFile,
                        hasExistingResourceImages: !!existingResourceImages,
                        isHairCategory
                    });
                }
            });

            console.log(`ğŸ” collectColorOptions ì™„ë£Œ - ìˆ˜ì§‘ëœ ìœ íš¨í•œ ì˜µì…˜: ${colorOptions.length}ê°œ`);
            return colorOptions;
        }

        // ì»¬ëŸ¬ ì˜µì…˜ ë¡œë“œ (ìˆ˜ì • ëª¨ë“œìš©)
        function loadColorOptions(colorOptions) {
            const container = document.getElementById('colorOptionsContainer');
            container.innerHTML = '';
            colorOptionIndex = 0;

            if (!colorOptions || colorOptions.length === 0) {
                addColorOption();
                return;
            }

            // ì¹´í…Œê³ ë¦¬ íƒ€ì… í™•ì¸
            const categoryId = document.getElementById('optionCategoryId').value;
            const category = categories.find(c => (c._id || c.id) === categoryId);
            const isHairCategory = category && category.type === 'hair';

            colorOptions.forEach((colorOption, index) => {
                console.log(`ğŸ” loadColorOptions - ì»¬ëŸ¬ ì˜µì…˜ ${index}:`, {
                    colorName: colorOption.colorName,
                    imageUrl: colorOption.imageUrl,
                    paletteImageUrl: colorOption.paletteImageUrl,
                    resourceImages: colorOption.resourceImages,
                    isHairCategory
                });
                
                colorOptionIndex++;
                const colorOptionDiv = document.createElement('div');
                colorOptionDiv.className = 'color-option-item';
                colorOptionDiv.setAttribute('data-index', colorOptionIndex);
                colorOptionDiv.setAttribute('data-image-url', colorOption.imageUrl);
                if (colorOption.paletteImageUrl) {
                    colorOptionDiv.setAttribute('data-palette-url', colorOption.paletteImageUrl);
                }

                const palettePreview = colorOption.paletteImageUrl ?
                    `<img src="${colorOption.paletteImageUrl}" alt="í˜„ì¬ íŒ”ë ˆíŠ¸" class="palette-circle" style="width: 64px; height: 64px; border-radius: 50%; object-fit: cover; margin-top: 5px;" onerror="this.style.display='none'; this.nextElementSibling.textContent='íŒ”ë ˆíŠ¸ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨';">
                     <div style="font-size: 12px; color: #666; margin-top: 5px;">í˜„ì¬ íŒ”ë ˆíŠ¸ ì´ë¯¸ì§€</div>` : 
                    `<div style="color: #999; text-align: center; padding: 10px; border: 1px dashed #ddd; border-radius: 50%; width: 64px; height: 64px; display: flex; align-items: center; justify-content: center; font-size: 11px; margin-top: 5px;">
                        íŒ”ë ˆíŠ¸<br>ì—†ìŒ
                     </div>`;

                // hair ì¹´í…Œê³ ë¦¬ìš© ê¸°ì¡´ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°
                const resourceImages = colorOption.resourceImages || {};
                const backHair = resourceImages.hairBackImageUrl || null;      // ë’·ë¨¸ë¦¬
                const middleHair = resourceImages.hairMiddleImageUrl || null;  // ì¤‘ê°„ë¨¸ë¦¬

                const hairFields = isHairCategory ? `
                    <div class="form-group hair-resource-group" style="border: 2px dashed #e74c3c; padding: 15px; border-radius: 5px; background: #fef5f5;">
                        <label>ğŸ’‡â€â™€ï¸ ì¤‘ê°„ë¨¸ë¦¬ ì´ë¯¸ì§€ (í•„ìˆ˜) *</label>
                        <input type="file" class="hair-middle-image" accept="image/*" onchange="previewHairResourceImage(this, 'middle')">
                        <div class="hair-middle-preview">
                            ${middleHair ? `
                                <img src="${middleHair}" alt="í˜„ì¬ ì¤‘ê°„ë¨¸ë¦¬" 
                                     style="max-width: 60px; max-height: 60px; border-radius: 3px; border: 1px solid #ddd; margin-top: 5px;"
                                     onerror="this.style.display='none'; this.nextElementSibling.textContent='ì¤‘ê°„ë¨¸ë¦¬ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨';">
                                <br><small style="color: #666;">í˜„ì¬ ì¤‘ê°„ë¨¸ë¦¬</small>
                                <br><small style="color: #999;">ìƒˆ íŒŒì¼ ì„ íƒ ì‹œ êµì²´ë©ë‹ˆë‹¤</small>
                            ` : `
                                <div style="color: #999; text-align: center; padding: 10px; border: 1px dashed #ddd; border-radius: 3px; margin-top: 5px;">
                                    <div>í˜„ì¬ ì¤‘ê°„ë¨¸ë¦¬ ì—†ìŒ</div>
                                    <small>íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”</small>
                                </div>
                            `}
                        </div>
                    </div>
                    <div class="form-group hair-resource-group" style="border: 2px dashed #3498db; padding: 15px; border-radius: 5px; background: #f0f8ff;">
                        <label>ğŸ’‡â€â™€ï¸ ë’·ë¨¸ë¦¬ ì´ë¯¸ì§€ (ì„ íƒ)</label>
                        <input type="file" class="hair-back-image" accept="image/*" onchange="previewHairResourceImage(this, 'back')">
                        <div class="hair-back-preview">
                            ${backHair ? `
                                <img src="${backHair}" alt="í˜„ì¬ ë’·ë¨¸ë¦¬" 
                                     style="max-width: 60px; max-height: 60px; border-radius: 3px; border: 1px solid #ddd; margin-top: 5px;"
                                     onerror="this.style.display='none'; this.nextElementSibling.textContent='ë’·ë¨¸ë¦¬ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨';">
                                <br><small style="color: #666;">í˜„ì¬ ë’·ë¨¸ë¦¬</small>
                                <br><small style="color: #999;">ìƒˆ íŒŒì¼ ì„ íƒ ì‹œ êµì²´ë©ë‹ˆë‹¤</small>
                            ` : '<div style="color: #999; text-align: center; padding: 10px; border: 1px dashed #ddd; border-radius: 3px; margin-top: 5px;"><div>í˜„ì¬ ë’·ë¨¸ë¦¬ ì—†ìŒ</div><small>íŒŒì¼ ì„ íƒ ì‹œ ì¶”ê°€ë©ë‹ˆë‹¤</small></div>'}
                        </div>
                        <small style="color: #666;">ì—†ìœ¼ë©´ ì¤‘ê°„ë¨¸ë¦¬ë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤</small>
                    </div>
                ` : '';

                colorOptionDiv.innerHTML = `
                    <div class="form-row">
                        <div class="form-group">
                            <label>ì»¬ëŸ¬ ì´ë¦„ *</label>
                            <input type="text" class="color-name" placeholder="ì˜ˆ: ë¹¨ê°•, íŒŒë‘" value="${colorOption.colorName}" required>
                        </div>
                        ${!isHairCategory ? `
                        <div class="form-group">
                            <label>ë¦¬ì†ŒìŠ¤ ì´ë¯¸ì§€ íŒŒì¼</label>
                            <input type="file" class="color-image" accept="image/*" onchange="previewColorImage(this)">
                            <div class="color-preview">
                                ${colorOption.imageUrl ? `
                                    <img src="${colorOption.imageUrl}" alt="í˜„ì¬ ì´ë¯¸ì§€" class="color-option-preview" 
                                         style="max-width: 60px; max-height: 60px; border-radius: 3px; border: 1px solid #ddd; margin-top: 5px;"
                                         onerror="this.style.display='none'; this.nextElementSibling.textContent='ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨';">
                                    <div style="font-size: 12px; color: #666; margin-top: 5px;">í˜„ì¬ ì´ë¯¸ì§€ (ìƒˆ íŒŒì¼ì„ ì„ íƒí•˜ë©´ êµì²´ë©ë‹ˆë‹¤)</div>
                                ` : `
                                    <div style="color: #999; text-align: center; padding: 10px; border: 1px dashed #ddd; border-radius: 3px;">
                                        <div>í˜„ì¬ ì´ë¯¸ì§€ ì—†ìŒ</div>
                                        <small>íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”</small>
                                    </div>
                                `}
                            </div>
                        </div>
                        ` : `
                        <div class="form-group" style="background: #fff3cd; padding: 10px; border-radius: 5px; border: 1px solid #ffeaa7;">
                            <div style="color: #856404; font-size: 14px;">
                                ğŸ’¡ <strong>Hair ì¹´í…Œê³ ë¦¬ ì•ˆë‚´:</strong><br>
                                ì¤‘ê°„ë¨¸ë¦¬ ì´ë¯¸ì§€ê°€ ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ìë™ ì„¤ì •ë©ë‹ˆë‹¤.<br>
                                ë³„ë„ì˜ ê¸°ë³¸ ì´ë¯¸ì§€ ì—…ë¡œë“œëŠ” ë¶ˆí•„ìš”í•©ë‹ˆë‹¤.
                            </div>
                        </div>
                        `}
                        <div class="form-group">
                            <label>ì»¬ëŸ¬ íŒ”ë ˆíŠ¸ (128x128)</label>
                            <input type="file" class="palette-image" accept="image/*" onchange="previewPaletteImage(this)">
                            <small>íŒ”ë ˆíŠ¸ ì´ë¯¸ì§€ë¥¼ ì„¤ì •í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ ì´ë¯¸ì§€ë¥¼ ë™ê·¸ë—ê²Œ í‘œì‹œí•©ë‹ˆë‹¤.</small>
                            <div class="palette-preview-container">${palettePreview}</div>
                        </div>
                        
                        ${hairFields}
                        
                        <div class="form-group" style="width: auto;">
                            <button type="button" onclick="removeColorOption(${colorOptionIndex})" class="btn-danger" style="margin-top: 24px;">ì‚­ì œ</button>
                        </div>
                    </div>
                `;
                container.appendChild(colorOptionDiv);
            });
        }

        // ì¹´í…Œê³ ë¦¬ ìƒì„± ëª¨ë‹¬ ì—´ê¸°
        function openCreateCategoryModal() {
            document.getElementById('categoryModalTitle').textContent = 'ğŸ“ ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€';
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryId').value = '';

            const modal = document.getElementById('categoryModal');
            modal.classList.add('show');
            modal.style.display = 'block';
        }

        // ì¹´í…Œê³ ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
        function closeCategoryModal() {
            const modal = document.getElementById('categoryModal');
            modal.classList.remove('show');
            modal.style.display = 'none';
        }

        // ì˜µì…˜ ìƒì„± ëª¨ë‹¬ ì—´ê¸°
        function openCreateOptionModal(categoryId) {
            document.getElementById('optionModalTitle').textContent = 'ğŸ­ ìƒˆ ìºë¦­í„° ì˜µì…˜ ì¶”ê°€';
            document.getElementById('optionForm').reset();
            document.getElementById('optionCategoryId').value = categoryId;
            document.getElementById('optionId').value = '';
            document.getElementById('thumbnailPreview').innerHTML = '';

            // ì»¬ëŸ¬ ì˜µì…˜ ì´ˆê¸°í™”
            const container = document.getElementById('colorOptionsContainer');
            container.innerHTML = '';
            colorOptionIndex = 0;
            addColorOption(); // ì²« ë²ˆì§¸ ì»¬ëŸ¬ ì˜µì…˜ ì¶”ê°€

            const modal = document.getElementById('optionModal');
            modal.classList.add('show');
            modal.style.display = 'block';
        }

        // ì˜µì…˜ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
        function openEditOptionModal(categoryId, optionId, optionName) {
            const category = categories.find(c => (c._id || c.id) === categoryId);
            if (!category || !category.options) {
                alert('ì¹´í…Œê³ ë¦¬ ë˜ëŠ” ì˜µì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const option = category.options.find(opt => (opt._id || opt.id) === optionId);
            if (!option) {
                alert('ì˜µì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            console.log(`ğŸ” openEditOptionModal - ì˜µì…˜ ë°ì´í„°:`, {
                optionName: option.name,
                categoryType: category.type,
                colorOptions: option.color,
                hasResourceImages: option.color?.some(c => c.resourceImages)
            });

            document.getElementById('optionModalTitle').textContent = `ğŸ­ ìºë¦­í„° ì˜µì…˜ ìˆ˜ì •: ${optionName}`;
            document.getElementById('optionCategoryId').value = categoryId;
            document.getElementById('optionId').value = optionId;
            document.getElementById('optionName').value = option.name;
            document.getElementById('optionOrder').value = option.order || 0;

            // ì»¬ëŸ¬ ì˜µì…˜ ë¡œë“œ
            loadColorOptions(option.color || []);

            // ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸°
            const thumbnailPreview = document.getElementById('thumbnailPreview');
            thumbnailPreview.innerHTML = option.thumbnailUrl ?
                `<img src="${option.thumbnailUrl}" alt="í˜„ì¬ ì¸ë„¤ì¼" class="image-preview" style="max-width: 100px; max-height: 100px;"><br><small>í˜„ì¬ ì¸ë„¤ì¼ (${option.thumbnailSource === 'user' ? 'ì‚¬ìš©ì ì œê³µ' : 'ìë™ ìƒì„±'})</small>` :
                '<p>í˜„ì¬ ì¸ë„¤ì¼ ì—†ìŒ</p>';

            const modal = document.getElementById('optionModal');
            modal.classList.add('show');
            modal.style.display = 'block';
        }

        // ì˜µì…˜ ëª¨ë‹¬ ë‹«ê¸°
        function closeOptionModal() {
            const modal = document.getElementById('optionModal');
            modal.classList.remove('show');
            modal.style.display = 'none';
        }

        // ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸° ì²˜ë¦¬
        document.getElementById('optionThumbnail').addEventListener('change', function (e) {
            const file = e.target.files[0];
            const preview = document.getElementById('thumbnailPreview');

            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸°" class="image-preview" style="max-width: 100px; max-height: 100px;">`;
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = '';
            }
        });

        // ì¹´í…Œê³ ë¦¬ í¼ ì œì¶œ
        document.getElementById('categoryForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            if (!currentToken) {
                alert('ê´€ë¦¬ì í† í°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            const categoryId = document.getElementById('categoryId').value;
            const isEdit = !!categoryId;

            // ì œì¶œ ë²„íŠ¼ ì°¾ê¸° ë° ë¹„í™œì„±í™”
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = isEdit ? 'ìˆ˜ì • ì¤‘...' : 'ì €ì¥ ì¤‘...';

            try {
                const formData = {
                    name: document.getElementById('categoryName').value,
                    type: document.getElementById('categoryType').value,
                    order: parseInt(document.getElementById('categoryOrder').value) || 0
                };

                const url = isEdit ?
                    `/api/admin/characters/categories/${categoryId}` :
                    '/api/admin/characters/categories';

                const response = await fetch(url, {
                    method: isEdit ? 'PUT' : 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`âœ… ì¹´í…Œê³ ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ${isEdit ? 'ìˆ˜ì •' : 'ì¶”ê°€'}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    closeCategoryModal();
                    loadCategories();
                } else {
                    alert(`âŒ ${isEdit ? 'ìˆ˜ì •' : 'ì¶”ê°€'} ì‹¤íŒ¨: ${data.message}`);
                }

            } catch (error) {
                console.error('ì¹´í…Œê³ ë¦¬ ì €ì¥ ì˜¤ë¥˜:', error);
                alert(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
            } finally {
                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // ì˜µì…˜ í¼ ì œì¶œ
        document.getElementById('optionForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            if (!currentToken) {
                alert('ê´€ë¦¬ì í† í°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            const categoryId = document.getElementById('optionCategoryId').value;
            const optionId = document.getElementById('optionId').value;
            const isEdit = !!optionId;
            const optionName = document.getElementById('optionName').value;

            // ì¹´í…Œê³ ë¦¬ íƒ€ì… í™•ì¸
            const category = categories.find(c => (c._id || c.id) === categoryId);
            const isHairCategory = category && category.type === 'hair';

            if (!optionName || optionName.trim() === '') {
                alert('ì˜µì…˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì»¬ëŸ¬ ì˜µì…˜ ìˆ˜ì§‘ ë° ê²€ì¦
            let colorOptions;
            try {
                colorOptions = collectColorOptions();
                if (colorOptions.length === 0) {
                    alert('ìµœì†Œ í•˜ë‚˜ì˜ ì»¬ëŸ¬ ì˜µì…˜ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    return;
                }
            } catch (error) {
                alert(error.message);
                return;
            }

            // ì œì¶œ ë²„íŠ¼ ì°¾ê¸° ë° ë¹„í™œì„±í™”
            const submitBtn = document.getElementById('submitOptionBtn');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = isEdit ? 'ìˆ˜ì • ì¤‘...' : 'ì €ì¥ ì¤‘...';

            try {
                // ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ì»¬ëŸ¬ ì˜µì…˜ ì¤€ë¹„
                const uploadedColorOptions = [];
                for (let colorOption of colorOptions) {
                    if (isHairCategory && colorOption.hairMiddleFile) {
                        // Hair ì¹´í…Œê³ ë¦¬: ì¤‘ê°„ë¨¸ë¦¬ ì´ë¯¸ì§€ ì—…ë¡œë“œ
                        const imageFormData = new FormData();
                        imageFormData.append('file', colorOption.hairMiddleFile);

                        const uploadResponse = await fetch('/api/upload', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${currentToken}`
                            },
                            body: imageFormData
                        });

                        if (uploadResponse.ok) {
                            const uploadData = await uploadResponse.json();
                            uploadedColorOptions.push({
                                colorName: colorOption.colorName,
                                imageUrl: uploadData.url, // ì¤‘ê°„ë¨¸ë¦¬ë¥¼ ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ì‚¬ìš©
                                paletteImageUrl: colorOption.paletteImageUrl || ''
                            });
                        } else {
                            throw new Error(`ì¤‘ê°„ë¨¸ë¦¬ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ${colorOption.colorName}`);
                        }
                    } else if (colorOption.imageFile) {
                        // ì¼ë°˜ ì¹´í…Œê³ ë¦¬: ìƒˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ
                        const imageFormData = new FormData();
                        imageFormData.append('file', colorOption.imageFile);

                        const uploadResponse = await fetch('/api/upload', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${currentToken}`
                            },
                            body: imageFormData
                        });

                        if (uploadResponse.ok) {
                            const uploadData = await uploadResponse.json();
                            uploadedColorOptions.push({
                                colorName: colorOption.colorName,
                                imageUrl: uploadData.url,
                                paletteImageUrl: colorOption.paletteImageUrl || ''
                            });
                        } else {
                            throw new Error(`ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ${colorOption.colorName}`);
                        }
                    } else if (colorOption.imageUrl) {
                        // ê¸°ì¡´ ì´ë¯¸ì§€ ìœ ì§€
                        uploadedColorOptions.push({
                            colorName: colorOption.colorName,
                            imageUrl: colorOption.imageUrl,
                            paletteImageUrl: colorOption.paletteImageUrl || ''
                        });
                    }
                }

                console.log(`ğŸ” uploadedColorOptions ìƒì„± ì™„ë£Œ:`, uploadedColorOptions);

                // ì˜µì…˜ ë°ì´í„° ì¤€ë¹„
                const formData = new FormData();
                formData.append('name', optionName);
                formData.append('colorOptions', JSON.stringify(uploadedColorOptions));
                formData.append('order', document.getElementById('optionOrder').value);

                const thumbnailFile = document.getElementById('optionThumbnail').files[0];
                if (thumbnailFile) {
                    formData.append('thumbnail', thumbnailFile);
                }

                // íŒ”ë ˆíŠ¸ ì´ë¯¸ì§€ë“¤ ë° hair íŒŒì¼ë“¤ ì¶”ê°€
                console.log(`ğŸ” FormData ì²˜ë¦¬ ì‹œì‘ - ì´ ${colorOptions.length}ê°œ ì»¬ëŸ¬ ì˜µì…˜`);
                colorOptions.forEach((colorOption, index) => {
                    console.log(`ğŸ” ì»¬ëŸ¬ ì˜µì…˜ ${index} ì²˜ë¦¬:`, {
                        colorName: colorOption.colorName,
                        hasPaletteFile: !!colorOption.paletteFile,
                        paletteFileName: colorOption.paletteFile?.name
                    });
                    
                    if (colorOption.paletteFile) {
                        formData.append('palette', colorOption.paletteFile);
                        console.log(`âœ… íŒ”ë ˆíŠ¸ ì´ë¯¸ì§€ ì¶”ê°€ (ìƒ‰ìƒ ì˜µì…˜ ${index}):`, colorOption.paletteFile.name);
                    } else {
                        console.log(`âš ï¸ ì»¬ëŸ¬ ì˜µì…˜ ${index}ì— íŒ”ë ˆíŠ¸ íŒŒì¼ ì—†ìŒ`);
                    }
                    
                    // Hair ì¹´í…Œê³ ë¦¬ì¸ ê²½ìš° ê° ì»¬ëŸ¬ë³„ hair íŒŒì¼ë“¤ ì¶”ê°€
                    if (isHairCategory) {
                        console.log(`ğŸ“¤ FormData ì¶”ê°€ - ì»¬ëŸ¬ ${index}:`, {
                            colorName: colorOption.colorName,
                            hasMiddleFile: !!colorOption.hairMiddleFile,
                            hasBackFile: !!colorOption.hairBackFile,
                            middleFileName: colorOption.hairMiddleFile?.name,
                            backFileName: colorOption.hairBackFile?.name
                        });
                        
                        if (colorOption.hairMiddleFile) {
                            formData.append(`hair_${index}_middle`, colorOption.hairMiddleFile);
                            console.log(`âœ… ì¤‘ê°„ë¨¸ë¦¬ íŒŒì¼ ì¶”ê°€: hair_${index}_middle`);
                        }
                        if (colorOption.hairBackFile) {
                            formData.append(`hair_${index}_back`, colorOption.hairBackFile);
                            console.log(`âœ… ë’·ë¨¸ë¦¬ íŒŒì¼ ì¶”ê°€: hair_${index}_back`);
                        }
                    }
                });

                const url = isEdit ?
                    `/api/admin/characters/categories/${categoryId}/options/${optionId}` :
                    `/api/admin/characters/categories/${categoryId}/options`;

                const response = await fetch(url, {
                    method: isEdit ? 'PUT' : 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`âœ… ì˜µì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ${isEdit ? 'ìˆ˜ì •' : 'ì¶”ê°€'}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    closeOptionModal();
                    await updateCategoryOptions(categoryId);
                } else {
                    alert(`âŒ ${isEdit ? 'ìˆ˜ì •' : 'ì¶”ê°€'} ì‹¤íŒ¨: ${data.message}`);
                }

            } catch (error) {
                console.error('ì˜µì…˜ ì €ì¥ ì˜¤ë¥˜:', error);
                alert(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
            } finally {
                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // ì¹´í…Œê³ ë¦¬ ìˆ˜ì •
        function editCategory(categoryId) {
            const category = categories.find(c => c._id === categoryId || c.id === categoryId);

            if (!category) {
                alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            document.getElementById('categoryModalTitle').textContent = 'ğŸ“ ì¹´í…Œê³ ë¦¬ ìˆ˜ì •';
            document.getElementById('categoryId').value = category._id || category.id;
            document.getElementById('categoryName').value = category.name;
            document.getElementById('categoryType').value = category.type;
            document.getElementById('categoryOrder').value = category.order || 0;

            const modal = document.getElementById('categoryModal');
            modal.classList.add('show');
            modal.style.display = 'block';
        }

        // ì¹´í…Œê³ ë¦¬ ì‚­ì œ
        async function deleteCategory(categoryId) {
            if (!confirm('ì •ë§ë¡œ ì´ ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ì˜µì…˜ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/characters/categories/${categoryId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    alert('âœ… ì¹´í…Œê³ ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadCategories();
                } else {
                    alert(`âŒ ì‚­ì œ ì‹¤íŒ¨: ${data.message}`);
                }

            } catch (error) {
                console.error('ì¹´í…Œê³ ë¦¬ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // ì˜µì…˜ ì‚­ì œ
        async function deleteOption(categoryId, optionId) {
            if (!confirm('ì •ë§ë¡œ ì´ ì˜µì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/characters/categories/${categoryId}/options/${optionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    alert('âœ… ì˜µì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    await updateCategoryOptions(categoryId);
                } else {
                    alert(`âŒ ì‚­ì œ ì‹¤íŒ¨: ${data.message}`);
                }

            } catch (error) {
                console.error('ì˜µì…˜ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // íŠ¹ì • ì¹´í…Œê³ ë¦¬ì˜ ì˜µì…˜ë§Œ ì—…ë°ì´íŠ¸
        async function updateCategoryOptions(categoryId) {
            try {
                const response = await fetch(`/api/admin/characters/categories/${categoryId}`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    const categoryIndex = categories.findIndex(c => (c._id || c.id) === categoryId);
                    if (categoryIndex !== -1) {
                        categories[categoryIndex] = data;

                        const optionsGrid = document.getElementById(`options-${categoryId}`);
                        if (optionsGrid) {
                            optionsGrid.innerHTML = renderOptions(data.options || [], categoryId);
                        }
                    }
                } else {
                    console.error('ì¹´í…Œê³ ë¦¬ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', data.message);
                }

            } catch (error) {
                console.error('ì¹´í…Œê³ ë¦¬ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }

        // ì¸ë„¤ì¼ ì¬ìƒì„±
        async function regenerateThumbnail(categoryId, optionId) {
            if (!confirm('ì´ ì˜µì…˜ì˜ ì¸ë„¤ì¼ì„ ì¬ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/characters/categories/${categoryId}/options/${optionId}/thumbnail/regenerate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    alert('âœ… ì¸ë„¤ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì¬ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    await updateCategoryOptions(categoryId);
                } else {
                    alert(`âŒ ì¸ë„¤ì¼ ì¬ìƒì„± ì‹¤íŒ¨: ${data.message}`);
                }

            } catch (error) {
                console.error('ì¸ë„¤ì¼ ì¬ìƒì„± ì˜¤ë¥˜:', error);
                alert(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function (event) {
            const categoryModal = document.getElementById('categoryModal');
            const optionModal = document.getElementById('optionModal');

            if (event.target === categoryModal) {
                closeCategoryModal();
            }
            if (event.target === optionModal) {
                closeOptionModal();
            }
        }
    </script>
</body>

</html>